<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeakLink - Municipal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom animations */
        @keyframes pop-in { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes slide-in { 0% { transform: translateY(30px) scale(0.98); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }

        .animate-pop-in { animation: pop-in 0.3s ease-out forwards; }
        .modal-backdrop { animation: fade-in 0.2s ease-out forwards; }
        .modal-content { animation: slide-in 0.3s ease-out forwards; }
        
        .modal-open { overflow: hidden; }

        .tab-btn.active {
            border-bottom-color: #2563EB; /* blue-600 */
            color: #1D4ED8; /* blue-700 */
            font-weight: 600;
        }
        .tab-btn {
            border-bottom: 4px solid transparent;
            transition: all 0.2s ease;
        }
        
        @keyframes pulse-border {
            0%, 100% { border-color: #EF4444; } /* red-500 */
            50% { border-color: #F87171; } /* red-400 */
        }
        .pulse-critical {
            animation: pulse-border 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Styles for Leaflet Map Pins */
        .leaflet-map-pin {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }
        .leaflet-map-pin:hover {
            transform: scale(1.2);
        }
        /* ðŸš€ MODIFIED: Updated status colors for better contrast */
        .pin-New { background-color: #2563EB; } /* blue-600 */
        .pin-Acknowledged { background-color: #38BDF8; } /* sky-400 */
        .pin-InProgress { background-color: #F59E0B; } /* amber-500 */
        .pin-Resolved { background-color: #10B981; } /* emerald-500 */

        @keyframes map-ping {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .map-pin-ping {
            position: absolute;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            animation: map-ping 1.5s ease-out infinite;
        }
        .ping-New { background-color: #2563EB; }
        .ping-Acknowledged { background-color: #38BDF8; }

        /* Style for hidden resolution section */
        .resolution-section {
            transition: all 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .resolution-section.active {
            max-height: 300px; /* Or some large enough value */
            opacity: 1;
        }
    </style>
</head>
<body class="font-sans" style="background-image: url('https://storage.googleapis.com/generative-ai-public-inference-output-prod-us-central1/image_generation_content/3'); background-size: cover; background-attachment: fixed;">

    <header class="bg-white/95 backdrop-blur-sm shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M7 16.3c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4Z"/><path d="M12.26 7.34C14.19 7 16 7.9 17 9.5s.5 3.8-1 5.3c-1.4 1.4-3.2 1.9-5 .5"/></svg>
                <h1 class="text-2xl font-bold text-gray-800 ml-2">LeakLink</h1>
                <p class="text-sm text-gray-500 ml-4 hidden md:block">Municipal Water Loss Management Dashboard</p>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500 hidden sm:block">Sponsored by:</span>
                <img src="https://placehold.co/120x40/F3F4F6/9CA3AF?text=EcoBrand" alt="Sponsor Logo" class="h-8">
            </div>
        </div>
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8" id="nav-tabs">
                <button data-tab="triage" class="tab-btn active py-3 px-1 text-sm">Triage Dashboard</button>
                <button data-tab="crews" class="tab-btn py-3 px-1 text-sm text-gray-500 hover:text-gray-700">Crew Management</button>
                <button data-tab="analytics" class="tab-btn py-3 px-1 text-sm text-gray-500 hover:text-gray-700">Analytics & Reporting</button>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="triage-page" class="tab-page">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="stats-cards">
                 </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-700">AI-Prioritized Queue</h2>
                        <div class="flex space-x-1 bg-gray-300/50 backdrop-blur-sm p-1 rounded-lg" id="filter-buttons">
                            <button data-filter="All" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors bg-white text-gray-800 shadow-sm">All</button>
                            <button data-filter="New" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-gray-500 hover:bg-gray-100">New</button>
                            <button data-filter="Acknowledged" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-gray-500 hover:bg-gray-100">Acknowledged</button>
                            <button data-filter="In Progress" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-gray-500 hover:bg-gray-100">In Progress</button>
                            <button data-filter="Resolved" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-gray-500 hover:bg-gray-100">Resolved</button>
                        </div>
                    </div>
                    <div class="space-y-4" id="report-list">
                        </div>
                </div>

                <div class="space-y-8">
                    <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-5 animate-pop-in" style="animation-delay: 500ms;">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Live Leakage Map</h3>
                        <div id="leaflet-map" class="bg-gray-200 rounded-lg h-80 relative overflow-hidden z-10">
                            </div>
                    </div>
                    <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-5 animate-pop-in" style="animation-delay: 600ms;">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Top JalRakshaks</h3>
                        <ul class="space-y-4" id="heroes-list">
                            </ul>
                        <div class="mt-4 pt-3 border-t border-gray-100 flex items-center justify-center gap-2">
                             <p class="text-xs text-gray-500">Rewards powered by</p>
                             <img src="https://placehold.co/100x30/F3F4F6/9CA3AF?text=EcoBrand" alt="Sponsor Logo" class="h-6">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="crews-page" class="tab-page hidden">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Crew Management & Routing</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-5">
                    <h3 class="font-bold text-lg text-gray-800 mb-4">Field Crew Status</h3>
                    <ul class="space-y-4" id="crew-list">
                        </ul>
                </div>
                <div class="md:col-span-2 bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-5">
                    <h3 class="font-bold text-lg text-gray-800 mb-4">Route Optimization</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label for="assign-crew" class="block text-sm font-medium text-gray-700">Assign to Crew</label>
                            <select id="assign-crew" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option>Select a crew...</option>
                                <option>Crew 1 (Idle)</option>
                                <option>Crew 2 (Idle)</option>
                                <option>Crew 3 (On-Site)</option>
                                <option>Crew 4 (On-Route)</option>
                                <option>Crew 5 (Idle)</option>
                                <option>Crew 6 (Idle)</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="assign-reports" class="block text-sm font-medium text-gray-700">Select New Reports to Add</label>
                            <div class="mt-1 p-2 h-24 border border-gray-300 rounded-md overflow-y-auto bg-gray-50 text-sm">
                                <p class="cursor-pointer hover:bg-gray-200 p-1 rounded">Report #4 (Critical)</p>
                                <p class="cursor-pointer hover:bg-gray-200 p-1 rounded">Report #8 (High)</p>
                                <p class="cursor-pointer hover:bg-gray-200 p-1 rounded">Report #11 (Medium)</p>
                                <p class="cursor-pointer hover:bg-gray-200 p-1 rounded">Report #14 (Medium)</p>
                            </div>
                        </div>
                        <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors h-fit self-end">Optimize Route</button>
                    </div>
                     <div class="mt-4 bg-gray-100 rounded-lg p-3">
                         <h4 class="font-semibold text-gray-800">Optimized Route for Crew 1:</h4>
                         <img src="https://storage.googleapis.com/support-forums-api/attachment/message-59123000-6707707561130458477.jpg"/>
                         <a href="#" class="text-blue-600 hover:underline mt-2 inline-block">Send route to crew's device</a>
                     </div>
                </div>
            </div>
        </div>

        <div id="analytics-page" class="tab-page hidden">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Analytics & Reporting</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div class="space-y-8">
                    <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-5">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Leak Hotspot Heatmap (Last 6 Months)</h3>
                        <div class="bg-gray-100 rounded-lg p-4">
                             <img src="https://aflyax.github.io/images/boston_heatmap.png" alt="A heatmap of leak reports" class="w-full h-auto object-contain rounded-lg"/>
                        </div>
                    </div>
                    
                    <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-5 border-l-4 border-blue-600">
                        <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2 text-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            Analytical Summary & Key Conclusions
                        </h3>
                        <div id="analytics-summary" class="text-gray-700 space-y-3 text-sm">
                            <p><strong>Hotspot Regions & User Awareness:</strong> Durban (KZN) and the Gauteng metros (Joburg/Pretoria) currently hold the highest concentration of open and resolved reports. This correlation suggests high user awareness and JalRakshak program effectiveness in these key urban centers.</p>
                            <p><strong>Resolution Performance:</strong> Cape Town reports show the fastest average time-to-resolution, with 3 recent reports fixed in two days or less. Durban and Pretoria have the highest number of pending (New, Acknowledged, or In Progress) high-severity issues, indicating resource or prioritization strain in these regions.</p>
                            <p><strong>Immediate Action:</strong> Critical leaks, such as the burst pipe in Pretoria (Report #4), require immediate dispatch to prevent high water loss, despite the high number of other pending medium-severity issues in other regions.</p>
                            <p class="text-xs italic pt-2 border-t mt-3 text-gray-500">Note: This summary is based on a snapshot of 15 mock reports from the initial data set.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-5">
                    <h3 class="font-bold text-lg text-gray-800 mb-4">Performance Dashboard</h3>
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-medium text-gray-700">Average Time-to-Resolution </h4>
                            <canvas id="resolutionTimeChart" class="mt-2"></canvas>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700">Report Types Logged</h4>
                            <canvas id="reportTypesChart" class="mt-2 max-h-64"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col md:flex-row modal-content">
            <div class="md:w-1/2 w-full h-64 md:h-auto">
                 <img id="modal-image" src="" alt="Leakage report" class="w-full h-full object-cover rounded-t-xl md:rounded-l-xl md:rounded-t-none">
            </div>
            <div class="md:w-1/2 w-full p-6 flex flex-col overflow-y-auto">
                <div class="flex-grow">
                    <div class="flex justify-between items-start">
                        <h2 id="modal-location" class="text-2xl font-bold text-gray-900 mb-2"></h2>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <span id="modal-status" class="inline-block px-3 py-1 text-sm font-semibold rounded-full mb-4"></span>
                    
                    <div class="mb-4">
                        <h3 class="font-semibold text-gray-700 mb-2">AI Analysis</h3>
                        <div class="bg-gray-50 rounded-lg p-3 space-y-3">
                            <div class="flex items-center gap-4">
                                <span id="ai-type-badge" class="px-3 py-1 text-xs font-semibold rounded-full"></span>
                                <span id="ai-severity-badge" class="px-3 py-1 text-xs font-semibold rounded-full"></span>
                            </div>
                            <div class="flex items-center">
                                <p><strong>Confidence:</strong> <span id="ai-confidence"></span>%</p>
                            </div>
                            <p id="ai-details" class="text-gray-600 text-sm italic"></p>
                            <p id="ai-duplicate" class="text-red-500 text-sm font-medium hidden"></p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3 class="font-semibold text-gray-700 mb-2">ðŸ¤– AI Recommendation</h3>
                        <div class="bg-blue-50 border-l-4 border-blue-400 rounded-r-lg p-3">
                            <p id="ai-recommendation" class="text-gray-800 text-sm"></p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-semibold text-gray-700 mb-2">User Information</h3>
                        <div class="flex items-center bg-gray-50 rounded-lg p-3">
                            <img id="modal-avatar" class="w-12 h-12 rounded-full mr-4" src="" alt="Avatar">
                            <div>
                                <p id="modal-username" class="font-bold text-gray-800"></p>
                                <div id="modal-userpoints" class="flex items-center text-sm text-yellow-500 font-semibold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    <span id="modal-points-text"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                     <div class="mb-4">
                         <h3 class="font-semibold text-gray-700 mb-2">Bi-Directional Communication Log</h3>
                         <div class="space-y-2 text-sm max-h-24 overflow-y-auto" id="modal-comm-log">
                             </div>
                         <div class="flex gap-2 mt-2">
                             <input id="comm-log-input" type="text" placeholder="Type a message to user..." class="flex-1 text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                             <button id="comm-log-send-btn" class="bg-gray-200 px-3 py-1 rounded-md text-sm font-medium hover:bg-gray-300">Send</button>
                         </div>
                     </div>
                    
                    <p id="modal-timestamp" class="text-xs text-gray-400 mt-2 text-center"></p>
                </div>
                
                <div id="resolution-reward-section" class="resolution-section mt-4">
                    <h3 class="font-semibold text-lg text-gray-800 mb-3 text-center">ðŸŽ‰ Resolution & Reward</h3>
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg space-y-3">
                        <div>
                            <label for="liters-saved-input" class="block text-sm font-medium text-gray-700">Estimated Water Saved (liters)</label>
                            <input type="number" id="liters-saved-input" placeholder="e.g., 8000" class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                        <button id="action-send-reward-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4"></path><polygon points="12 12 22 7 17 17 12 12"></polygon></svg>
                            Send Final Update & Reward
                        </button>
                    </div>
                </div>

                <div id="action-button-group" class="mt-6 flex flex-col sm:flex-row gap-3">
                     <select id="assign-crew-dropdown" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                         <option value="">Assign to...</option>
                         <option value="Crew 1">Crew 1</option>
                         <option value="Crew 2">Crew 2</option>
                         <option value="Crew 3">Crew 3</option>
                         <option value="Crew 4">Crew 4</option>
                         <option value="Crew 5">Crew 5</option>
                         <option value="Crew 6">Crew 6</option>
                     </select>
                     
                     <button id="action-acknowledge-btn" class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        Acknowledge Report
                     </button>
                     <button id="action-assign-btn" class="flex-1 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors flex items-center justify-center gap-2">
                         Assign Crew
                     </button>
                     <button id="action-resolve-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                         Mark as Resolved
                     </button>
                </div>
                <button id="action-merge-btn" class="hidden w-full mt-3 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                    Merge with Report #...
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Mock Data (Expanded & Themed) ---

        // ðŸš€ NEW: Mock Sponsor Data
        const sponsor = {
            name: 'EcoBrand',
            logo: 'https://placehold.co/120x40/F3F4F6/9CA3AF?text=EcoBrand',
            rewardText: 'a 10% off voucher at EcoBrand'
        };

        const initialReports = [
             // ðŸš€ MODIFIED: Added 15 reports, all SA-localised
            {
                id: 1,
                userName: 'Sipho Dlamini',
                userAvatar: 'https://placehold.co/100x100/EBF4FF/3B82F6?text=SD',
                location: 'Midrand, Johannesburg',
                lat: -25.9961,
                lng: 28.1219,
                image: 'https://www.paloaltoplumbing.net/wp-content/uploads/2021/01/Methods-to-Detect-Water-Leaks-.jpg',
                timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                status: 'Acknowledged', 
                aiAnalysis: {
                    type: 'Burst',
                    confidence: 96,
                    severity: 'High',
                    details: 'Major pipeline burst detected on a public street. Immediate action recommended.',
                    duplicateFlag: '85% similar to Report #3'
                },
                userPoints: 150,
                commLog: [ 
                    { from: 'bot', msg: 'Report received. (Ref #1)', time: '1 hour ago' },
                    { from: 'bot', msg: 'Report Acknowledged. We are verifying the issue.', time: '5 minutes ago' }
                ]
            },
            {
                id: 2,
                userName: 'Nomusa Mkhize',
                userAvatar: 'https://placehold.co/100x100/FEF3C7/F59E0B?text=NM',
                location: 'Durban North, Durban',
                lat: -29.7709,
                lng: 31.0268,
                image: 'https://warmserve-services.co.uk/wp-content/uploads/2024/10/AdobeStock_234736184-1024x683.jpg',
                timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                status: 'In Progress',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 88,
                    severity: 'Medium',
                    details: 'Significant water overflow from a manhole cover. Possible sewer blockage or pipe leak.',
                    duplicateFlag: null
                },
                userPoints: 120,
                commLog: [
                    { from: 'bot', msg: 'Report received. (Ref #2)', time: '5 hours ago' },
                    { from: 'bot', msg: 'Report Acknowledged. We are verifying the issue.', time: '4 hours ago' },
                    { from: 'operator', msg: 'Report verified. Crew 1 has been assigned.', time: '3 hours ago' }
                ]
            },
            {
                id: 3,
                userName: 'Lwazi Molefe',
                userAvatar: 'https://placehold.co/100x100/FEE2E2/DC2626?text=LM',
                location: 'Claremont, Cape Town',
                lat: -33.9877,
                lng: 18.4674,
                image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSlYPUlyPdI7fHL63uNNeNHcuAuVcHUqnhFKw&s',
                timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'Resolved',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 75,
                    severity: 'Low',
                    details: 'Minor continuous drip from a public tap. Low priority but should be monitored.',
                    duplicateFlag: null
                },
                userPoints: 250,
                commLog: [
                    { from: 'bot', msg: 'Report received. (Ref #3)', time: '2 days ago' },
                    { from: 'operator', msg: 'Report verified. Crew 3 assigned.', time: '1 day ago' },
                    { from: 'operator', msg: 'ðŸŽ‰ Leak Fixed! Your action helped save an estimated 1,000 liters. Thank you!', time: '4 hours ago' },
                    { from: 'bot', msg: `ðŸŽ Your ${sponsor.name} reward has been sent!`, time: '4 hours ago' }
                ]
            },
            {
                id: 4,
                userName: 'Zanele Ndlovu',
                userAvatar: 'https://placehold.co/100x100/E5E7EB/4B5563?text=ZN',
                location: 'Pretoria East, Pretoria',
                lat: -25.7592,
                lng: 28.2327,
                image: 'https://phdyuma.com/wp-content/uploads/2024/02/PL-1495624975-Water-leakage-at-shut-off-valve-and-pipe-1024x683.jpg',
                timestamp: new Date(Date.now() - 10 * 60 * 60 * 1000).toISOString(),
                status: 'New',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 99,
                    severity: 'Critical',
                    details: 'Fire hydrant appears to be damaged and is actively spraying large volumes of water.',
                    duplicateFlag: null
                },
                userPoints: 80,
                 commLog: [ { from: 'bot', msg: 'Report received. (Ref #4)', time: '10 hours ago' } ]
            },
            {
                id: 5,
                userName: 'Sipho Dlamini',
                userAvatar: 'https://placehold.co/100x100/EBF4FF/3B82F6?text=SD',
                location: 'Sandton, Johannesburg',
                lat: -26.1076,
                lng: 28.0567,
                image: 'https://media.assettype.com/resident%2F2024-12-26%2Fqdoxebzk%2F13.jpg?w=480&auto=format%2Ccompress&fit=max',
                timestamp: new Date(Date.now() - 15 * 60 * 60 * 1000).toISOString(),
                status: 'New',
                aiAnalysis: {
                    type: 'Theft',
                    confidence: 85,
                    severity: 'High',
                    details: 'User reports potential illegal connection to main water line. Visible piping bypassing meter.',
                    duplicateFlag: null
                },
                userPoints: 150, // Added to previous 150
                 commLog: [ { from: 'bot', msg: 'Report received. (Ref #5)', time: '15 hours ago' } ]
            },
            {
                id: 6,
                userName: 'David Lee',
                userAvatar: 'https://placehold.co/100x100/DBEAFE/1E40AF?text=DL',
                location: 'Sea Point, Cape Town',
                lat: -33.9180,
                lng: 18.3918,
                image: 'https://www.titanplumbingandelectric.com/wp-content/uploads/2024/08/signs-of-a-hidden-water-leak.jpg',
                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'In Progress',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 92,
                    severity: 'Medium',
                    details: 'Continuous stream from pavement crack. Likely underground pipe leak.',
                    duplicateFlag: null
                },
                userPoints: 120,
                 commLog: [ 
                      { from: 'bot', msg: 'Report received. (Ref #6)', time: '1 day ago' },
                      { from: 'operator', msg: 'Thanks David, Crew 2 is investigating.', time: '6 hours ago' }
                 ]
            },
            {
                id: 7,
                userName: 'Thandiwe Zulu',
                userAvatar: 'https://placehold.co/100x100/FCE7F3/831843?text=TZ',
                location: 'Musgrave, Durban',
                lat: -29.8491,
                lng: 30.9800,
                image: 'https://www.ultratechcement.com/content/ultratechcement/in/en/home/for-homebuilders/home-building-explained-single/descriptive-articles/water-leakage-problems-and-its-solutions/_jcr_content/root/container/container_2072089177/teaser_copy_1777596728.coreimg.jpeg/1711525657535/water-proofing-8.jpeg',
                timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'Resolved',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 80,
                    severity: 'Low',
                    details: 'Slow drip from park water fountain. Low priority.',
                    duplicateFlag: null
                },
                userPoints: 250,
                 commLog: [ 
                    { from: 'bot', msg: 'Report received. (Ref #7)', time: '3 days ago' }, 
                    { from: 'operator', msg: 'Resolved.', time: '1 day ago' },
                    { from: 'bot', msg: `ðŸŽ Your ${sponsor.name} reward has been sent!`, time: '1 day ago' }
                ]
            },
             {
                id: 8,
                userName: 'Zanele Ndlovu',
                userAvatar: 'https://placehold.co/100x100/E5E7EB/4B5563?text=ZN',
                location: 'Centurion, Pretoria',
                lat: -25.8672,
                lng: 28.1884,
                image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQksRrckHPJTJpxG1pyVR2pcz0Asymg2jukEg&s',
                timestamp: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
                status: 'New',
                aiAnalysis: {
                    type: 'Burst',
                    confidence: 95,
                    severity: 'High',
                    details: 'Loud noise and water bubbling from tarmac. Imminent burst pipe.',
                    duplicateFlag: null
                },
                userPoints: 80, // Added to previous 80
                 commLog: [ { from: 'bot', msg: 'Report received. (Ref #8)', time: '30 minutes ago' } ]
            },
             {
                id: 9,
                userName: 'Nomusa Mkhize',
                userAvatar: 'https://placehold.co/100x100/FEF3C7/F59E0B?text=NM',
                location: 'Pietermaritzburg Central, PMB',
                lat: -29.6001,
                lng: 30.3794,
                image: 'https://escarosacleaningandrestoration.com/wp-content/uploads/2023/03/Pipe-inside-wall-min.png',
                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'Acknowledged',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 70,
                    severity: 'Medium',
                    details: 'Damp patch on the wall of a municipal building. Internal leak suspected.',
                    duplicateFlag: null
                },
                userPoints: 120, // Added to previous 120
                 commLog: [ 
                    { from: 'bot', msg: 'Report received. (Ref #9)', time: '1 day ago' },
                    { from: 'bot', msg: 'Report Acknowledged. We are verifying the issue.', time: '10 hours ago' }
                 ]
            },
            {
                id: 10,
                userName: 'Sipho Dlamini',
                userAvatar: 'https://placehold.co/100x100/EBF4FF/3B82F6?text=SD',
                location: 'Rosebank, Johannesburg',
                lat: -26.1422,
                lng: 28.0371,
                image: 'https://thebrisbaneplumbers.com.au/wp-content/uploads/2024/01/water-leakage-1030x579.jpg',
                timestamp: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'Resolved',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 90,
                    severity: 'Medium',
                    details: 'Slight persistent leak under traffic light robot. Now fixed.',
                    duplicateFlag: null
                },
                userPoints: 250, // Added to previous 300
                 commLog: [ 
                    { from: 'bot', msg: 'Report received. (Ref #10)', time: '4 days ago' },
                    { from: 'operator', msg: 'Resolved by Crew 4.', time: '2 days ago' },
                    { from: 'bot', msg: `ðŸŽ Your ${sponsor.name} reward has been sent!`, time: '2 days ago' }
                 ]
            },
            {
                id: 11,
                userName: 'Lwazi Molefe',
                userAvatar: 'https://placehold.co/100x100/FEE2E2/DC2626?text=LM',
                location: 'Mitchells Plain, Cape Town',
                lat: -34.0270,
                lng: 18.5996,
                image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQIzsMCqvfZBrK2hKr2WXdKf8DZ3XcltLUEew&s',
                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'Resolved',
                aiAnalysis: {
                    type: 'Drip',
                    confidence: 80,
                    severity: 'Low',
                    details: 'Intermittent dripping from an irrigation line near a park. Fixed as part of routine maintenance.',
                    duplicateFlag: null
                },
                userPoints: 120, // Added to previous 250
                 commLog: [ 
                     { from: 'bot', msg: 'Report received. (Ref #11)', time: '1 day ago' },
                     { from: 'operator', msg: 'Resolved.', time: '10 hours ago' },
                     { from: 'bot', msg: `ðŸŽ Your ${sponsor.name} reward has been sent!`, time: '10 hours ago' }
                 ]
            },
            {
                id: 12,
                userName: 'Thandiwe Zulu',
                userAvatar: 'https://placehold.co/100x100/FCE7F3/831843?text=TZ',
                location: 'Umlazi, Durban',
                lat: -30.0102,
                lng: 30.8653,
                image: 'https://static.vecteezy.com/system/resources/thumbnails/067/300/760/small/extreme-close-up-of-crystal-clear-water-droplet-falling-from-metal-pipe-photo.jpg',
                timestamp: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
                status: 'New',
                aiAnalysis: {
                    type: 'Drip',
                    confidence: 65,
                    severity: 'Low',
                    details: 'Small, intermittent drip from an exposed pipe near a business.',
                    duplicateFlag: null
                },
                userPoints: 80, // Added to previous 250
                 commLog: [ { from: 'bot', msg: 'Report received. (Ref #12)', time: '45 minutes ago' } ]
            },
            {
                id: 13,
                userName: 'Zanele Ndlovu',
                userAvatar: 'https://placehold.co/100x100/E5E7EB/4B5563?text=ZN',
                location: 'Lynnwood, Pretoria',
                lat: -25.7538,
                lng: 28.2520,
                image: 'https://edis.ifas.ufl.edu/image/HS388/7945733/14253400/14253400-2048.webp',
                timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
                status: 'In Progress',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 82,
                    severity: 'Medium',
                    details: 'Damp patch on municipal pavement. Low flow, but persistent.',
                    duplicateFlag: null
                },
                userPoints: 120, // Added to previous 160
                 commLog: [ 
                    { from: 'bot', msg: 'Report received. (Ref #13)', time: '6 hours ago' },
                    { from: 'operator', msg: 'Crew 5 is on the way to investigate.', time: '1 hour ago' }
                 ]
            },
            {
                id: 14,
                userName: 'Lwazi Molefe',
                userAvatar: 'https://placehold.co/100x100/FEE2E2/DC2626?text=LM',
                location: 'Mowbray, Cape Town',
                lat: -33.9472,
                lng: 18.4682,
                image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQn_n1i9n_L_m0L_T3I3_LzJ4Zl5Y8J8Y4gQ&s',
                timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'Resolved',
                aiAnalysis: {
                    type: 'Leak',
                    confidence: 78,
                    severity: 'Low',
                    details: 'Small leak at a meter connection. Easy fix.',
                    duplicateFlag: null
                },
                userPoints: 120, // Added to previous 370
                 commLog: [ 
                      { from: 'bot', msg: 'Report received. (Ref #14)', time: '3 days ago' },
                      { from: 'operator', msg: 'Resolved.', time: '2 days ago' },
                      { from: 'bot', msg: `ðŸŽ Your ${sponsor.name} reward has been sent!`, time: '2 days ago' }
                 ]
            },
            {
                id: 15,
                userName: 'Nomusa Mkhize',
                userAvatar: 'https://placehold.co/100x100/FEF3C7/F59E0B?text=NM',
                location: 'Phoenix, Durban',
                lat: -29.6923,
                lng: 30.9575,
                image: 'https://www.prolinerubber.com/wp-content/uploads/2021/01/Pinch-off-clamps-for-leaks.jpg',
                timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                status: 'New',
                aiAnalysis: {
                    type: 'Burst',
                    confidence: 90,
                    severity: 'Critical',
                    details: 'User reports sudden, large volume of water from the main road. High severity, potential road damage.',
                    duplicateFlag: null
                },
                userPoints: 80, // Added to previous 240
                 commLog: [ { from: 'bot', msg: 'Report received. (Ref #15)', time: '1 hour ago' } ]
            },
        ];

        // ðŸš€ NEW: Mock Crew Data - Increased crew count
        const crews = [
            { id: 1, name: 'Crew 1 (Alpha)', status: 'Idle', location: 'Midrand Depot' },
            { id: 2, name: 'Crew 2 (Bravo)', status: 'On-Route', location: 'To Sea Point' },
            { id: 3, name: 'Crew 3 (Charlie)', status: 'On-Site', location: 'Claremont Site' },
            { id: 4, name: 'Crew 4 (Delta)', status: 'Idle', location: 'Rosebank Depot' },
            { id: 5, name: 'Crew 5 (Echo)', status: 'On-Route', location: 'To Lynnwood' },
            { id: 6, name: 'Crew 6 (Foxtrot)', status: 'Idle', location: 'Umhlanga Depot' },
        ];

        // --- Color Maps ---
        // ðŸš€ MODIFIED: Added 'Acknowledged' status
        const statusColors = {
            New: 'bg-blue-100 text-blue-800 border-l-8 border-blue-500',
            Acknowledged: 'bg-sky-100 text-sky-800 border-l-8 border-sky-500',
            'In Progress': 'bg-yellow-100 text-yellow-800 border-l-8 border-yellow-500',
            Resolved: 'bg-green-100 text-green-800 border-l-8 border-green-500',
        };
        const severityColors = {
            Low: 'text-green-600',
            Medium: 'text-yellow-600',
            High: 'text-orange-600',
            Critical: 'text-red-600',
        };
        const severityBadges = {
            Low: 'bg-green-100 text-green-800',
            Medium: 'bg-yellow-100 text-yellow-800',
            High: 'bg-orange-100 text-orange-800',
            Critical: 'bg-red-100 text-red-800',
        };
        // ðŸš€ MODIFIED: Added Drip as a type
        const typeBadges = {
            Leak: 'bg-blue-100 text-blue-800',
            Burst: 'bg-indigo-100 text-indigo-800',
            Theft: 'bg-red-100 text-red-800',
            Drip: 'bg-teal-100 text-teal-800',
            Other: 'bg-gray-100 text-gray-800'
        };

        // --- State Management ---
        let reports = [...initialReports];
        let selectedReport = null;
        let currentFilter = 'All';
        let activeTab = 'triage';
        let map = null;
        let mapMarkers = [];
        let reportTypesChart = null;
        let resolutionTimeChart = null;

        // --- DOM Elements ---
        const reportListEl = document.getElementById('report-list');
        const filterButtonsEl = document.getElementById('filter-buttons');
        const navTabsEl = document.getElementById('nav-tabs');
        const statsCardsEl = document.getElementById('stats-cards');
        const heroesListEl = document.getElementById('heroes-list');
        const crewListEl = document.getElementById('crew-list');

        const modalEl = document.getElementById('report-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const commLogEl = document.getElementById('modal-comm-log');

        // --- Utility Functions ---
        const timeAgo = (date) => {
             const seconds = Math.floor((new Date() - new Date(date)) / 1000);
             let interval = seconds / 31536000;
             if (interval > 1) return Math.floor(interval) + " years ago";
             interval = seconds / 2592000;
             if (interval > 1) return Math.floor(interval) + " months ago";
             interval = seconds / 86400;
             if (interval > 1) return Math.floor(interval) + " days ago";
             interval = seconds / 3600;
             if (interval > 1) return Math.floor(interval) + " hours ago";
             interval = seconds / 60;
             if (interval > 1) return Math.floor(interval) + " minutes ago";
             return Math.floor(seconds) + " seconds ago";
        };

        const generateAIRecommendation = (report) => {
            const { severity, type } = report.aiAnalysis;
            const location = report.location.split(',')[0];
            
            if (severity === 'Critical') {
                return `Critical ${type} at ${location}. Recommend **IMMEDIATE dispatch** of nearest idle crew (Crew 1, 4, or 6). High risk of property damage.`;
            }
            if (severity === 'High') {
                return `High severity ${type}. Recommend dispatch within 2-4 hours. Assign to nearest available crew.`;
            }
            if (severity === 'Medium') {
                return `Medium severity ${type}. Schedule for next available crew, (within 24 hours). Monitor for escalation.`;
            }
            return `Low severity ${type}. Add to routine maintenance queue. No immediate action required.`;
        };

        // --- Render Functions ---

        function renderStats() {
            const stats = {
                total: reports.length,
                new: reports.filter(r => r.status === 'New').length,
                acknowledged: reports.filter(r => r.status === 'Acknowledged').length,
                inProgress: reports.filter(r => r.status === 'In Progress').length,
            };

            statsCardsEl.innerHTML = `
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-4 animate-pop-in">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"></path></svg>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-500">Total Reports</h4>
                            <p class="text-3xl font-bold text-gray-800">${stats.total}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-4 animate-pop-in" style="animation-delay: 100ms;">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-full">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-500">Urgent: New/Critical</h4>
                            <p class="text-3xl font-bold text-red-600">${reports.filter(r => r.status === 'New' && r.aiAnalysis.severity === 'Critical').length + stats.new}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-4 animate-pop-in" style="animation-delay: 200ms;">
                    <div class="flex items-center">
                        <div class="p-3 bg-sky-100 rounded-full">
                            <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-500">Acknowledged Reports</h4>
                            <p class="text-3xl font-bold text-sky-600">${stats.acknowledged}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-4 animate-pop-in" style="animation-delay: 300ms;">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-full">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-500">Repairs In Progress</h4>
                            <p class="text-3xl font-bold text-yellow-600">${stats.inProgress}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReports() {
            const severityOrder = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
            const sortedReports = reports.sort((a, b) => {
                return (severityOrder[b.aiAnalysis.severity] || 0) - (severityOrder[a.aiAnalysis.severity] || 0);
            });
            const filteredReports = sortedReports.filter(r => currentFilter === 'All' || r.status === currentFilter);

            reportListEl.innerHTML = '';

            if (filteredReports.length === 0) {
                reportListEl.innerHTML = `<div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-8 text-center text-gray-500">No reports match the current filter.</div>`;
                return;
            }

            filteredReports.forEach((report, index) => {
                let severityClass = severityColors[report.aiAnalysis.severity] || 'text-gray-500';
                let borderColorClass = statusColors[report.status] || 'border-l-8 border-gray-500';
                
                if (report.aiAnalysis.severity === 'Critical' && report.status === 'New') {
                    borderColorClass = 'border-l-8 border-red-500 pulse-critical';
                }

                const type = report.aiAnalysis.type || 'Other';
                const typeBadge = typeBadges[type] || typeBadges['Other'];

                // ðŸš€ MODIFIED: Added AI Type and Confidence bar to the report card
                const reportCardHTML = `
                    <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg overflow-hidden hover:shadow-xl hover:ring-2 hover:ring-blue-400 transition-all duration-300 report-card cursor-pointer animate-pop-in" data-id="${report.id}" style="animation-delay: ${index * 50}ms;">
                        <div class="p-4 ${borderColorClass}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center min-w-0">
                                    <img class="w-10 h-10 rounded-full mr-3" src="${report.userAvatar}" alt="Avatar">
                                    <div class="min-w-0">
                                        <p class="font-bold text-gray-800 truncate">${report.userName}</p>
                                        <span class="text-sm text-gray-500 truncate">${report.location}</span>
                                    </div>
                                </div>
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColors[report.status].split(' ')[0]} ${statusColors[report.status].split(' ')[1]} flex-shrink-0">
                                    ${report.status}
                                </span>
                            </div>
                            <div class="mt-3 flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="font-semibold ${severityClass} flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                        ${report.aiAnalysis.severity}
                                    </span>
                                    <span class="font-medium ${typeBadge.split(' ')[1]} flex items-center">
                                        ${type}
                                    </span>
                                </div>
                                <span class="text-xs text-gray-500">${timeAgo(report.timestamp)}</span>
                            </div>
                            <div class="mt-2">
                                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                                    <div class="h-1.5 rounded-full" style="width: ${report.aiAnalysis.confidence}%; background-color: #2563EB;"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 text-right">AI Confidence: ${report.aiAnalysis.confidence}%</p>
                            </div>
                        </div>
                    </div>
                `;
                reportListEl.innerHTML += reportCardHTML;
            });
        }

        function renderHeroes() {
            const userReports = reports.reduce((acc, report) => {
                const existing = acc.find(u => u.name === report.userName);
                if (existing) {
                    existing.reports += 1;
                    existing.points += report.userPoints;
                } else {
                    acc.push({
                        name: report.userName,
                        avatar: report.userAvatar,
                        reports: 1,
                        points: report.userPoints
                    });
                }
                return acc;
            }, []);

            userReports.sort((a, b) => b.points - a.points);

            heroesListEl.innerHTML = '';
            userReports.slice(0, 5).forEach((user, index) => {
                let medal;
                if (index === 0) medal = 'ðŸ¥‡';
                else if (index === 1) medal = 'ðŸ¥ˆ';
                else if (index === 2) medal = 'ðŸ¥‰';
                else medal = `<span class="font-bold text-gray-400 w-6">${index + 1}.</span>`;

                heroesListEl.innerHTML += `
                    <li class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50">
                        <div class="flex items-center">
                            <span class="text-xl w-6 text-center">${medal}</span>
                            <img class="w-10 h-10 rounded-full mr-3 ml-2" src="${user.avatar}" alt="Avatar">
                            <div>
                                <p class="font-semibold text-gray-700">${user.name}</p>
                                <p class="text-xs text-gray-500">${user.reports} report(s)</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-yellow-600">${user.points} pts</p>
                        </div>
                    </li>
                `;
            });
        }
        
        function initializeMap() {
            if (map) return;

            map = L.map('leaflet-map').setView([-29.0, 24.0], 5); // South African coordinates

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.fitBounds([
                [-34.0270, 18.3752], // Cape Town (West/South)
                [-25.7592, 31.0664] // Durban/Pretoria (East/North)
            ]);
        }
        
        function renderLeafletPins() {
            if (!map) initializeMap();

            mapMarkers.forEach(marker => marker.remove());
            mapMarkers = [];

            reports.forEach(report => {
                const latLng = [report.lat, report.lng];
                const statusClass = report.status.replace(' ', '');
                
                const pingHtml = (report.status === 'New' || report.status === 'Acknowledged') ? `<div class="map-pin-ping ping-${statusClass}"></div>` : '';

                const icon = L.divIcon({
                    className: 'custom-leaflet-icon',
                    html: `
                        <div class="leaflet-map-pin pin-${statusClass}"></div>
                        ${pingHtml}
                    `,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                const marker = L.marker(latLng, { icon: icon }).addTo(map);

                marker.on('click', () => {
                    handleReportClick({ target: marker._icon });
                });
                marker._icon.dataset.id = report.id;
                mapMarkers.push(marker);
            });
        }
        
        function renderCrews() {
            crewListEl.innerHTML = '';
            crews.forEach(crew => {
                const statusColor = crew.status === 'Idle' ? 'text-green-500' : (crew.status === 'On-Route' ? 'text-blue-500' : 'text-yellow-600');
                const bgColor = crew.status === 'Idle' ? 'bg-green-100' : (crew.status === 'On-Route' ? 'bg-blue-100' : 'bg-yellow-100');
                
                crewListEl.innerHTML += `
                    <li class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 border-b">
                        <div>
                            <p class="font-semibold text-gray-800">${crew.name}</p>
                            <p class="text-xs text-gray-500">${crew.location}</p>
                        </div>
                        <span class="text-sm font-medium ${statusColor} ${bgColor} px-3 py-1 rounded-full">${crew.status}</span>
                    </li>
                `;
            });
        }

        function renderAnalyticsCharts() {
            // Data for Report Types (Doughnut Chart)
            const reportTypeCounts = reports.reduce((acc, r) => {
                const type = r.aiAnalysis.type || 'Other';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const doughnutData = {
                labels: Object.keys(reportTypeCounts),
                datasets: [{
                    data: Object.values(reportTypeCounts),
                    backgroundColor: [
                        '#2563EB', // Leak (blue)
                        '#4F46E5', // Burst (indigo)
                        '#DC2626', // Theft (red)
                        '#0D9488', // Drip (teal)
                        '#9CA3AF'  // Other (gray)
                    ],
                    hoverOffset: 4
                }]
            };

            const doughnutCtx = document.getElementById('reportTypesChart');
            if (!doughnutCtx) return;

            if (reportTypesChart) {
                reportTypesChart.destroy();
            }

            reportTypesChart = new Chart(doughnutCtx, {
                type: 'doughnut',
                data: doughnutData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                    }
                },
            });

            // Data for Resolution Time (Bar Chart)
            const resolutionData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], // Mock months
                datasets: [{
                    label: 'Avg. Time (Days)',
                    data: [2.5, 2.1, 1.8, 1.5, 1.2, 0.9], // Mock data
                    backgroundColor: '#10B981'
                }]
            };

            const barCtx = document.getElementById('resolutionTimeChart');
            if (!barCtx) return;

            if (resolutionTimeChart) {
                resolutionTimeChart.destroy();
            }
            
            resolutionTimeChart = new Chart(barCtx, {
                type: 'bar',
                data: resolutionData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // --- Modal Functions ---
        let commSendBtnListener = null;

        function openModal(report) {
            selectedReport = report;
            document.body.classList.add('modal-open');
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');

            // Populate basic info
            document.getElementById('modal-image').src = report.image;
            document.getElementById('modal-location').textContent = report.location;
            const statusEl = document.getElementById('modal-status');
            statusEl.textContent = `Status: ${report.status}`;
            statusEl.className = `inline-block px-3 py-1 text-sm font-semibold rounded-full mb-4 ${statusColors[report.status].split(' ')[0]} ${statusColors[report.status].split(' ')[1]}`;

            // Populate AI Info
            const type = report.aiAnalysis.type || 'Other';
            const typeBadge = typeBadges[type] || typeBadges['Other'];
            
            const typeEl = document.getElementById('ai-type-badge');
            typeEl.textContent = type;
            typeEl.className = `px-3 py-1 text-xs font-semibold rounded-full ${typeBadge}`;
            
            const severityEl = document.getElementById('ai-severity-badge');
            severityEl.textContent = `${report.aiAnalysis.severity} Severity`;
            severityEl.className = `px-3 py-1 text-xs font-semibold rounded-full ${severityBadges[report.aiAnalysis.severity] || 'bg-gray-100 text-gray-800'}`;
            
            document.getElementById('ai-confidence').textContent = `${report.aiAnalysis.confidence}`;
            document.getElementById('ai-details').textContent = report.aiAnalysis.details;
            document.getElementById('ai-recommendation').textContent = generateAIRecommendation(report);
            
            const duplicateEl = document.getElementById('ai-duplicate');
            const mergeBtn = document.getElementById('action-merge-btn');
            if (report.aiAnalysis.duplicateFlag) {
                duplicateEl.textContent = `Flag: ${report.aiAnalysis.duplicateFlag}`;
                duplicateEl.classList.remove('hidden');
                mergeBtn.textContent = `Merge with ${report.aiAnalysis.duplicateFlag.split(' ')[2]}`;
                mergeBtn.classList.remove('hidden');
            } else {
                duplicateEl.classList.add('hidden');
                mergeBtn.classList.add('hidden');
            }

            // Populate User Info
            document.getElementById('modal-avatar').src = report.userAvatar;
            document.getElementById('modal-username').textContent = report.userName;
            document.getElementById('modal-points-text').textContent = `${reports.filter(r => r.userName === report.userName).reduce((sum, r) => sum + r.userPoints, 0)} Points (Trust Score: ${reports.filter(r => r.userName === report.userName).reduce((sum, r) => sum + r.userPoints, 0) > 300 ? 'High' : 'Medium'})`;
            document.getElementById('modal-timestamp').textContent = `Reported on ${new Date(report.timestamp).toLocaleString()}`;
            
            // Populate Comm Log
            const renderCommLog = () => {
                 commLogEl.innerHTML = '';
                 report.commLog.forEach(log => {
                     const isOperator = log.from === 'operator';
                     const msgClass = isOperator ? 'bg-blue-50 text-blue-800 border-l-2 border-blue-400 p-2 rounded-r-md' : 'bg-gray-100 text-gray-700 border-l-2 border-gray-400 p-2 rounded-r-md';
                     const sender = isOperator ? 'Operator' : 'AI/System';
                     
                     commLogEl.innerHTML += `
                         <div class="${msgClass}">
                             <p class="font-semibold">${sender}:</p>
                             <p>${log.msg}</p>
                             <p class="text-xs text-gray-500 text-right">${log.time}</p>
                         </div>
                     `;
                 });
                 commLogEl.scrollTop = commLogEl.scrollHeight; // Auto-scroll to bottom
            };
            renderCommLog();
            
            // Re-attach listener for sending messages
            const commSendBtn = document.getElementById('comm-log-send-btn');
            const commInput = document.getElementById('comm-log-input');

            // Remove old listener if it exists
            if (commSendBtnListener) {
                commSendBtn.removeEventListener('click', commSendBtnListener);
            }
            
            // Create and store new listener
            commSendBtnListener = () => {
                 const message = commInput.value.trim();
                 if (message) {
                     const newLog = { 
                         from: 'operator', 
                         msg: `Operator replied: "${message}"`, 
                         time: 'Just now' 
                     };
                     report.commLog.push(newLog);
                     renderCommLog();
                     commInput.value = '';
                 }
            };

            commSendBtn.addEventListener('click', commSendBtnListener);
            
            // --- ðŸš€ NEW: Workflow Action Button Logic ---
            const actionGroup = document.getElementById('action-button-group');
            const ackBtn = document.getElementById('action-acknowledge-btn');
            const assignBtn = document.getElementById('action-assign-btn');
            const resolveBtn = document.getElementById('action-resolve-btn');
            const crewDropdown = document.getElementById('assign-crew-dropdown');
            const rewardSection = document.getElementById('resolution-reward-section');
            const rewardBtn = document.getElementById('action-send-reward-btn');

            // Reset UI state
            ackBtn.style.display = 'none';
            assignBtn.style.display = 'none';
            resolveBtn.style.display = 'none';
            crewDropdown.style.display = 'none';
            rewardSection.classList.remove('active');
            actionGroup.style.display = 'flex';

            // Show buttons based on status
            if (report.status === 'New') {
                ackBtn.style.display = 'flex';
            } else if (report.status === 'Acknowledged') {
                assignBtn.style.display = 'flex';
                crewDropdown.style.display = 'block';
            } else if (report.status === 'In Progress') {
                resolveBtn.style.display = 'flex';
            } else if (report.status === 'Resolved') {
                actionGroup.style.display = 'none'; // All actions done
            }
            
            // --- Add Event Listeners (using clones to prevent duplicates) ---
            // 1. Acknowledge Button
            const newAckBtn = ackBtn.cloneNode(true);
            newAckBtn.addEventListener('click', () => {
                 const newLog = { from: 'bot', msg: 'Report Acknowledged. We are verifying the issue.', time: 'Just now' };
                 report.commLog.push(newLog);
                 updateStatus(report.id, 'Acknowledged');
            });
            ackBtn.parentNode.replaceChild(newAckBtn, ackBtn);

            // 2. Assign Button
            const newAssignBtn = assignBtn.cloneNode(true);
            newAssignBtn.addEventListener('click', () => {
                 const crewName = crewDropdown.value;
                 if (!crewName) {
                     alert('Please select a crew to assign.');
                     return;
                 }
                 const newLog = { from: 'operator', msg: `Report verified. ${crewName} has been assigned.`, time: 'Just now' };
                 report.commLog.push(newLog);
                 updateStatus(report.id, 'In Progress');
            });
            assignBtn.parentNode.replaceChild(newAssignBtn, assignBtn);

            // 3. Resolve Button (opens reward panel)
            const newResolveBtn = resolveBtn.cloneNode(true);
            newResolveBtn.addEventListener('click', () => {
                 actionGroup.style.display = 'none';
                 rewardSection.classList.add('active');
            });
            resolveBtn.parentNode.replaceChild(newResolveBtn, resolveBtn);

            // 4. Send Reward Button (Final Resolution)
            const newRewardBtn = rewardBtn.cloneNode(true);
            newRewardBtn.addEventListener('click', () => {
                 const litersSaved = document.getElementById('liters-saved-input').value;
                 if (!litersSaved) {
                     alert('Please enter the estimated water saved.');
                     return;
                 }
                 const finalLog = { from: 'operator', msg: `ðŸŽ‰ Leak Fixed! Your action helped save an estimated ${litersSaved} liters. Thank you!`, time: 'Just now' };
                 const rewardLog = { from: 'bot', msg: `ðŸŽ Your ${sponsor.name} reward has been sent!`, time: 'Just now' };
                 report.commLog.push(finalLog);
                 report.commLog.push(rewardLog);
                 updateStatus(report.id, 'Resolved');
            });
            rewardBtn.parentNode.replaceChild(newRewardBtn, rewardBtn);
            
            
        }

        function closeModal() {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
            document.body.classList.remove('modal-open');
            selectedReport = null;
            rerenderAll(); // Re-render triage dashboard to update status/pins
        }
        
        // --- Event Handlers ---
        function handleTabClick(e) {
            const button = e.target.closest('.tab-btn');
            if (!button) return;

            activeTab = button.dataset.tab;

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            document.querySelectorAll('.tab-page').forEach(page => page.classList.add('hidden'));
            document.getElementById(`${activeTab}-page`).classList.remove('hidden');

            // Initialize/re-render components for the new tab
            if (activeTab === 'triage') {
                 rerenderTriage();
            } else if (activeTab === 'crews') {
                renderCrews();
            } else if (activeTab === 'analytics') {
                renderAnalyticsCharts();
            }
        }

        function handleFilterClick(e) {
            const button = e.target.closest('.filter-btn');
            if (!button) return;
            
            currentFilter = button.dataset.filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-gray-800', 'shadow-sm');
                btn.classList.add('text-gray-500', 'hover:bg-gray-100');
            });
            
            button.classList.add('bg-white', 'text-gray-800', 'shadow-sm');
            button.classList.remove('text-gray-500', 'hover:bg-gray-100');
            
            renderReports();
        }

        function handleReportClick(e) {
            const card = e.target.closest('.report-card, .custom-leaflet-icon');
            if (!card) return;

            const reportId = parseInt(card.dataset.id);
            const report = reports.find(r => r.id === reportId);

            if (report) {
                openModal(report);
            }
        }

        function updateStatus(id, newStatus) {
            reports = reports.map(report => report.id === id ? { ...report, status: newStatus } : report );
            
            // Re-render UI elements affected by status change
            if (selectedReport && selectedReport.id === id) {
                 selectedReport.status = newStatus;
                 openModal(selectedReport); // Re-open the modal with new status/buttons
            } else if (activeTab === 'triage') {
                rerenderTriage();
            } else if (activeTab === 'crews') {
                renderCrews();
            } else if (activeTab === 'analytics') {
                renderAnalyticsCharts();
            }
        }
        
        // --- Initial Load ---
        function rerenderTriage() {
            renderStats();
            renderReports();
            renderHeroes();
            renderLeafletPins();
        }

        function rerenderAll() {
            if (activeTab === 'triage') {
                rerenderTriage();
            } else if (activeTab === 'crews') {
                renderCrews();
            } else if (activeTab === 'analytics') {
                renderAnalyticsCharts();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            rerenderTriage(); 
            
            navTabsEl.addEventListener('click', handleTabClick);
            filterButtonsEl.addEventListener('click', handleFilterClick);
            reportListEl.addEventListener('click', handleReportClick);
            closeModalBtn.addEventListener('click', closeModal);
            document.getElementById('report-list').addEventListener('click', handleReportClick);
            
            modalEl.addEventListener('click', (e) => {
                if (e.target === modalEl) {
                    closeModal();
                }
            });
        });

    </script>
</body>
</html>
